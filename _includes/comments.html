<section class="comments">
  <h2>Leave a Comment</h2>

  <!-- Netlify Form -->
  <form name="post-comments" netlify netlify-honeypot="bot-field" hidden>
    <input type="text" name="name">
    <input type="email" name="email">
    <textarea name="comment"></textarea>
    <input type="hidden" name="post-url" value="{{ page.url }}">
  </form>

  <!-- Visible Form -->
  <div class="comment-form">
    <input type="text" id="name" placeholder="Name" required>
    <input type="email" id="email" placeholder="Email (optional)">
    <textarea id="comment" placeholder="Your comment..." required></textarea>
    <button onclick="submitComment()">Post Comment</button>
  </div>

  <!-- Comments List -->
  <div class="comments-list">
    <!-- Dynamically populated -->
  </div>

  <style>
    .comments { max-width: 800px; margin: 2rem auto; padding: 1rem; }
    .comment-form { display: grid; gap: 1rem; }
    input, textarea { padding: 0.5rem; border: 1px solid #ddd; }
    button { padding: 0.5rem 1rem; background: #007bff; color: white; border: none; }
    .comment { padding: 1rem; margin: 1rem 0; background: #f8f9fa; }
  </style>

  <script>
  async function submitComment() {
    const comment = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      comment: document.getElementById('comment').value,
      "post-url": window.location.pathname
    };

    await fetch('/', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams(comment).toString()
    });

    // Clear form
    document.querySelector('.comment-form').reset();
    loadComments();
  }

  async function loadComments() {
    const response = await fetch(`/.netlify/functions/get-comments?post=${encodeURIComponent(window.location.pathname)}`);
    const comments = await response.json();

    const container = document.querySelector('.comments-list');
    container.innerHTML = comments.map(c => `
      <div class="comment">
        <h4>${c.name}</h4>
        <p>${c.comment}</p>
        <small>${new Date(c.date).toLocaleDateString()}</small>
      </div>
    `).join('');
  }

  // Load comments when page loads
  window.addEventListener('DOMContentLoaded', loadComments);
  </script>
</section>
